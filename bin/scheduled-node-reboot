#!/bin/sh

if [ $# -eq 0 ] ; then
    echo usage "scripts/scheduled-node-reboot [--date string] [--url URL] <CN> ..."
    exit 1
fi

ARGS=

while [ $# -gt 0 ] ; do
    if [ $1 == "--date" ] ; then
        DATE="- $2"
        shift
    elif [ $1 == "--url" ] ; then
        URL="- $2"
        shift
    elif [ $1 == "-T" ] ; then
        if [ `expr match $2 '.*@.*'` -ge 1 ] ; then
            TEST_TO="-T $2"
            shift
        elif [ "X$EMAIL" != "X" ] ; then
            TEST_TO="-T $EMAIL"
        else
            echo "-T requires an email address"
            exit 1
        fi
    else
        ARGS="$ARGS --host $1.qld.nectar.org.au"
    fi
    shift
done

cd ~/git/qcif-mailout
. venv/bin/activate

mailout/mailout.py -y $TEST_TO \
                   -s "Advice: QRIScloud instance reboot scheduled $DATE" \
  --template scheduled-node-reboot --by-group instances $ARGS --managers --members

exit
